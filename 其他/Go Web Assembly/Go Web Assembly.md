## â˜‚ï¸ å¥½è¯å†™åœ¨å‰é¢

å¥½è¯å†™åœ¨å‰é¢ï¼Œ ä¹Ÿå†™åœ¨åé¢ï¼Œå¤§å®¶å¥½ï¼Œæˆ‘æ˜¯éŸ©æ•°ï¼Œ æœ¬æ¥æ‰“ç®—å†™ä¸€äº› golang å…¶ä»–çš„å†…å®¹çš„ï¼Œ åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­å‘ç° (Wasm) WebAssembly
è¿™ä¸ªä¸œè¥¿ï¼Œäºæ˜¯ä¸€é˜µå¥½å¥‡å°±å¥½å¥‡äº†ä¸€ä¸‹ï¼ŒæŠŠç©äº†äº†ä¸€ä¸‹å°±æŠŠç©äº†ä¸€ä¸‹ã€‚ åœ¨äº†è§£ Wasm çš„è¿‡ç¨‹ä¸­ç¿»é˜…äº†å®˜ç½‘å’Œå¾ˆå¤šèµ„æ–™ï¼Œ ä¸ºäº†é¿å…ä¹‹åçš„æœ‹å‹ä»¬å†å­¦ä¹  WebAssembly çš„æ—¶å€™è¸©å‘ï¼Œäºæ˜¯æ‰å†³å®šå†™ä¸‹è¿™ç¯‡åšå®¢ã€‚

æœ¬æ–‡æ¶‰åŠåˆ°çš„ä»£ç ç¤ºä¾‹ä»¥åŠç¬”è®°å†…å®¹å·²ç»å¼€æºè‡³ `GitHub`:  [éŸ©æ•°çš„å­¦ä¹ ç¬”è®°-è¥¿è¥¿å¼—ç‰ˆæœ¬](https://github.com/hanshuaikang/HanShu-Note-Sisyphus)

## ğŸ›€ğŸ½ WebAssembly çš„å®šä¹‰

> Wasm (WebAssembly) æ˜¯ä¸€ç§è¿è¡Œåœ¨ Web æµè§ˆå™¨ä¸Šçš„é«˜æ•ˆã€å®‰å…¨çš„ç¼–ç¨‹è¯­è¨€ï¼Œæ—¨åœ¨ä¸º Web åº”ç”¨æä¾›ä¸€ä¸ªæ›´å¿«ã€æ›´å®‰å…¨ã€æ›´çµæ´»çš„è¿è¡Œç¯å¢ƒã€‚Wasm é€šè¿‡æä¾›äºŒè¿›åˆ¶çš„æ ¼å¼å’Œç›¸å…³çš„ APIï¼Œä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿåœ¨ Web æµè§ˆå™¨ä¸Šè¿è¡Œ C/C++ ç­‰è¯­è¨€ç¼–å†™çš„ä»£ç ï¼Œä»è€Œå®ç°æ›´å¿«ã€æ›´é«˜æ•ˆçš„ Web åº”ç”¨ã€‚

åœ¨è¿™é‡Œæˆ‘ä»¬ç°ä¸æ‰¯ä»€ä¹ˆ Web Assembly çš„ä¼˜ç¼ºç‚¹ï¼Œ æˆ‘ä»¬å…ˆçœ‹çœ‹ Wasm è¿™é¡¹æŠ€æœ¯å…·ä½“è§£å†³äº†ä»€ä¹ˆé—®é¢˜ï¼Œåœ¨å®ƒçš„ä»‹ç»é‡Œé¢æŒ‡çš„æ˜¯è¿™è¡Œå­—: `ä»è€Œå®ç°æ›´å¿«ã€æ›´é«˜æ•ˆçš„ Web åº”ç”¨ã€‚`

ä¸ºä»€ä¹ˆè¦å®ç° `ä»è€Œå®ç°æ›´å¿«ã€æ›´é«˜æ•ˆçš„ Web åº”ç”¨`å‘¢ï¼Œè¿™æ˜¯ä¸€ä¸ªå¾…è§£å†³çš„é—®é¢˜å—ï¼Ÿ  é—®è¿™ä¸ªé—®é¢˜ï¼Œä¸å¦‚é—®ï¼š ä½ æƒ³åœ¨æµè§ˆå™¨ç©å„¿ã€Šé»‘ç¥è¯æ‚Ÿç©ºå—ã€‹ï¼Ÿ å¦‚æœä½ æ˜¯ä¸€å®¶è½¯ä»¶å…¬å¸çš„è€æ¿ï¼Œå‘Šè¯‰ä½ ä»¬å…¬å¸çš„ Web å‰ç«¯è¯´, å¸®æˆ‘å†™ä¸€ä¸ªèƒ½åœ¨æµè§ˆå™¨è¿è¡Œçš„é»‘ç¥è¯æ‚Ÿç©º, ä»–å½“æ—¶è„¸ä¸Šé‡Œä¸€å®šæ˜¯æƒ³è¦ææ­»ä½ çš„è¡¨æƒ…ã€‚

è™½ç„¶ js ç›®å‰å·²ç»æˆä¸ºä¸–ç•Œä¸Šè¢«ä½¿ç”¨æœ€å¹¿æ³›çš„è¯­è¨€ï¼Œä½†æ˜¯éœ€è¦å¤§å‹ CPU å¯†é›†å‹é¡¹ç›®è¿™ä»¶äº‹ä¸Šä»ç„¶åŠ›ä¸ä»å¿ƒã€‚ è™½ç„¶ V8 å¼•æ“çš„å‡ºç°çŠ¹å¦‚ä¸€é“å…‰èŠ’ç…§è¿›äº† js çš„ä¸–ç•Œé‡Œï¼Œä½†æ˜¯é€Ÿåº¦ä»ç„¶æ¯”ä¸ä¸Šæ—©å·²ç»è£…ä¸Šæ›²ç‡å¼•æ“çš„é™æ€ç¼–è¯‘å‹è¯­è¨€ä¸Š(C, C++)ã€‚ æ›´ä½•å†µ js è¿˜æ˜¯åŠ¨æ€ç±»å‹, ä¸ºä»€ä¹ˆ js è¿™ä¹ˆæ…¢å‘¢(ç›¸è¾ƒäºé™æ€ç¼–è¯‘å‹è¯­è¨€)ã€‚æˆ‘ä»¬éœ€è¦å…ˆçœ‹ä¸‹ js çš„æ‰§è¡Œæµç¨‹, å¦‚ä¸‹å›¾æ‰€ç¤º:

![1.jpg](./img/1.jpg)

åœ¨æˆ‘ä»¬çš„ä¸€æ®µ js ä»£ç çœŸæ­£çš„è½¬æ¢æˆäºŒè¿›åˆ¶åœ¨ç¡¬ä»¶ä¸Šæ‰§è¡Œæ—¶,  éœ€è¦ç»è¿‡ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤:

1.  ä¸‹è½½ js ä»£ç æ–‡ä»¶ï¼Œ è¿™æ˜¯ä¸€åˆ‡çš„å¼€å§‹
2.  è¿›å…¥ `Parser` æ­¥éª¤, `Parser` ä¸»è¦è´Ÿè´£å°†æˆ‘ä»¬çš„ js æ–‡ä»¶è§£ææˆæŠ½è±¡è¯­æ³•æ ‘(AST)ã€‚ åœ¨è¿™ä¸ªé˜¶æ®µå¯ä»¥é€šè¿‡è¯­æ³•åˆ†æå‘ç°ä¸€äº›ç¼–è¯‘æ—¶å¯ä»¥å‘ç°çš„é—®é¢˜ã€‚ä¾‹å¦‚ä½¿ç”¨äº†æœªå®šä¹‰çš„å˜é‡ï¼Œå‡½æ•°å°‘äº†ä¸ªèŠ±æ‹¬å·ç­‰ã€‚
3.  ç¬¬ä¸‰æ­¥ä¼šç»è¿‡ `Ignition`ã€‚ åœ¨è¿™ä¸€æ­¥ js çš„ AST ä¼šè¢«è§£é‡Šå™¨è½¬æ¢æˆ Bytecode å­—èŠ‚ç ï¼Œè§£é‡Šå¹¶æ‰§è¡ŒBytecode, è¿™é‡Œçš„ Bytecode æ˜¯å­—èŠ‚ç ï¼Œ
4.  `TurboFan` ç¼–è¯‘å™¨ï¼Œ ç¼–è¯‘å™¨ä¼šæŠŠå­—èŠ‚ç è½¬æ¢æˆæ±‡ç¼–ä»£ç ï¼Œ åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­å¦‚æœä¸€ä¸ªå‡½æ•°è¢«å¤šæ¬¡æ‰§è¡Œï¼Œå°±ä¼šè¢«è®¤ä¸ºæ˜¯çƒ­ç‚¹å‡½æ•°ï¼Œä¼šè¢« JIT å¼•æ“ç¼–è¯‘æˆ æœºå™¨ç ï¼Œè¿™æ ·ä¸‹æ¬¡å†æ‰§è¡Œåˆ°è¿™ä¸ªå‡½æ•°çš„æ—¶å€™, å°±ä¼šæ‰§è¡Œç›´æ¥ç¼–è¯‘å¥½çš„ æœºå™¨ç ã€‚ åˆçœ‹è¿™ä¸ªæµç¨‹æ˜¯å¾ˆå®Œç¾çš„, ä»£ç è·‘çš„è¶Šä¹…æ€§èƒ½è¶Šé«˜ï¼Œéš”å£çš„ java å°±æ˜¯é ç€ `è™šæ‹Ÿæœº+JIT` æŠ€æœ¯åœ¨æ€§èƒ½ä¸Šå‹ python è¿™äº›åŒæ ·æ˜¯è§£é‡Šå‹çš„è¯­è¨€ä¸€å¤´çš„ã€‚ ä½†æ˜¯ç”±äº Java æ˜¯é™æ€ç±»å‹çš„è¯­è¨€ï¼Œ å› æ­¤ JIT ç¼–è¯‘ä¹‹åçš„æœºå™¨ç å‡ ä¹ä¸ä¼šå­˜åœ¨å¤±æ•ˆçš„æƒ…å†µã€‚ä½† js ä¸ä¸€æ ·äº†ï¼Œ ä¸Šä¸€æ¬¡æ‰§è¡Œå¯èƒ½å…¥å‚æ—¶ Array ä¸‹æ¬¡å°±å¯èƒ½ä¼šå˜æˆ intã€‚ **é‚£ä¹ˆ JIT è¾›è¾›è‹¦è‹¦åšçš„ä¼˜åŒ–å°±å‰åŠŸå°½å¼ƒäº†**ã€‚

ç»“åˆä»¥ä¸Šå‡ ç‚¹ï¼Œæˆ‘ä»¬å‘ç°ï¼Œå³ä½¿åœ¨æœ€å®Œç¾çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨ type js åœ¨ç¼–å†™æ—¶æå‰çº¦å®šå¥½ç±»å‹(ç¼–è¯‘æˆjsä»ç„¶æ˜¯åŠ¨æ€å¼±ç±»å‹çš„)ï¼Œ å‡å°‘ JIT ç™½å¿™æ´»çš„æ¦‚ç‡ï¼Œä½†æ˜¯ç”±äºé’ˆå¯¹æ¯è¡Œä»£ç ä»ç„¶éœ€è¦ç»è¿‡ `Parser` å’Œ `Ignition` è¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œå› æ­¤å¯¹æ€§èƒ½çš„ä¼˜åŒ–ä¹Ÿåªèƒ½æ˜¯ æ”¶æ•ˆç”šå¾® ã€‚

äºæ˜¯ `asm.js`è¯ç”Ÿäº†ã€‚

## ğŸ›ŒğŸ½ æ’æ›² asm.js

2012å¹´ï¼ŒMozilla çš„å·¥ç¨‹å¸ˆÂ [Alon Zakai](https://github.com/kripken)Â åœ¨ç ”ç©¶ LLVM ç¼–è¯‘å™¨æ—¶çªå‘å¥‡æƒ³ï¼šè®¸å¤š 3D æ¸¸æˆéƒ½æ˜¯ç”¨ C / C++ è¯­è¨€å†™çš„ï¼Œå¦‚æœèƒ½å°† C / C++ è¯­è¨€ç¼–è¯‘æˆ JavaScript ä»£ç ï¼Œå®ƒä»¬ä¸å°±èƒ½åœ¨æµè§ˆå™¨é‡Œè¿è¡Œäº†å—ï¼Ÿä¼—æ‰€å‘¨çŸ¥ï¼ŒJavaScript çš„åŸºæœ¬è¯­æ³•ä¸ C è¯­è¨€é«˜åº¦ç›¸ä¼¼ã€‚äºæ˜¯ï¼Œä»–å¼€å§‹ç ”ç©¶æ€ä¹ˆæ‰èƒ½å®ç°è¿™ä¸ªç›®æ ‡ï¼Œä¸ºæ­¤ä¸“é—¨åšäº†ä¸€ä¸ªç¼–è¯‘å™¨é¡¹ç›®Â [Emscripten](https://github.com/kripken/emscripten)ã€‚è¿™ä¸ªç¼–è¯‘å™¨å¯ä»¥å°† C / C++ ä»£ç ç¼–è¯‘æˆ JS ä»£ç ï¼Œä½†ä¸æ˜¯æ™®é€šçš„ JSï¼Œè€Œæ˜¯ä¸€ç§å«åšÂ [asm.js](http://asmjs.org/)Â çš„ JavaScript å˜ä½“ã€‚

asm.js æ˜¯ JavaScript å­é›†ã€‚ åªèƒ½ä½¿ç”¨ JavaScript ä¸€éƒ¨åˆ†è¯­æ³•ï¼Œæ—¢ç„¶jså› ä¸ºåŠ¨æ€ç±»å‹æ‰æ…¢ï¼Œä¼šåœ¨ Parser è¿™ä¸€æ­¥èŠ±è´¹å¤§é‡çš„æ—¶é—´åœ¨è¯­æ³•æ£€æŸ¥ä¸Šã€‚è€Œ asm.js å› ä¸ºä¸¥æ ¼çº¦æŸäº†ç±»å‹ï¼Œå‡å°‘äº† JavaScript ä¸­åŠ¨æ€ç±»å‹æ£€æŸ¥çš„å¼€é”€, åŒæ ·ç”±äº asm.js å¾ˆå¤šè¯­æ³•å¾ˆæ¥è¿‘æ±‡ç¼–ã€‚ å› æ­¤å¾ˆå¤šç¼–è¯‘å™¨ä¹Ÿé’ˆå¯¹ asm.js è¿›è¡Œäº†ä¼˜åŒ–ã€‚ ä½†ç”±äº asm.js æ ¼é™å®šäº†ç±»å‹,  æ¢æ¥çš„ä»£ä»·å°±æ˜¯å¯è¯»æ€§å˜å¾—å°±å¾ˆå·®,  å¯¹äºæˆ‘è¿™ç§è¢«é«˜çº§è¯­è¨€æƒ¯åäº†çš„äººè€Œè¨€ï¼Œ æœ‰ç‚¹æ™¦æ¶©äº†ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ª asm.js å†™çš„ + 1 çš„ä¾‹å­ã€‚

```js
function add1(x) {
    x = x|0; // x æ˜¯ä¸€ä¸ªæ•´æ•°
    return (x+1)|0; // è¿”å›å€¼è½¬æ¢ä¸ºæ•´æ•°
}
```

è‡³äºæ€§èƒ½çš„éƒ¨åˆ†ï¼Œå…³äº asm.js ç½‘ä¸Šçš„èµ„æ–™å¾ˆå°‘ï¼Œ æ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡Œè§‚çœ‹ [The JavaScript Compile Target Asm.js](https://johnresig.com/blog/asmjs-javascript-compile-target/) è¿™ä¸€ç¯‡æ–‡ç« ï¼Œå¤§æ¦‚æ˜¯åœ¨ 2013 å¹´å‘å¸ƒçš„ï¼Œ ç»“è®ºè‚¯å®šæ˜¯æ›´å¿«çš„ï¼Œ è¿™ç¯‡æ–‡ç« é‡Œé¢æå¤§æ¦‚æ˜¯å¯ä»¥å’Œ java çš„æ€§èƒ½ç›¸åª²ç¾ï¼Œ c++ çš„äºŒåˆ†ä¹‹ä¸€ã€‚

å¥½, æ’æ›²è®²å®Œï¼Œæ¥ä¸‹æ¥å¼€å§‹å¯ä»¥è½®åˆ°æˆ‘ä»¬çš„ä¸»è§’ç™»åœºäº†ï¼Œå½“å½“å½“å½“ï¼Œå½“å½“å½“å½“ï¼ˆè°¨ä»¥æ­¤8ä¸ªå­—æ‚¼å¿µ21ä¸–çºªçš„ç¦å…‹æ–¯ï¼‰ã€‚ æœ‰è¯· `WebAssembly` é—ªäº®ç™»åœºã€‚ğŸ‡ğŸ‡ğŸ‰ğŸ‰

## ğŸ® WebAssembly å‡ºåœºï¼Œæˆ‘æ¥æ‹¯æ•‘ä¸–ç•Œå•¦ã€‚

è™½ç„¶ asm.js  å¼ºç±»å‹ï¼Œå¾ˆå¿«ï¼Œä½†æ˜¯ä»¥å·¨å¤§çš„å¯è¯»æ€§ä¸ºä»£ä»·ä»ç„¶æ²¡æœ‰æ¢æ¥éå¸¸å¯è§‚çš„æ€§èƒ½æå‡ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Œå› ä¸º asm.js è™½ç„¶æ˜¯ JavaScript çš„å­é›†ï¼Œä½†æ˜¯æ‰§è¡Œçš„æ—¶å€™ä»ç„¶éœ€è¦ ç»è¿‡ `Parser` å’Œ  `Ignition` è¿™ä¸¤ä¸ªè€—æ—¶çš„æ­¥éª¤ï¼Œäºæ˜¯å¤©æ‰å°±æƒ³ï¼Œå¦‚æœæµè§ˆå™¨èƒ½å¤Ÿç›´æ¥æ‰§è¡Œ `å­—èŠ‚ç ` é‚£å²‚ä¸æ˜¯`æ€§èƒ½èµ·é£`ï¼Ÿ

WebAssembly ä¸åŒäº asm.jsã€‚ WebAssembly `æ˜¯ä¸€ç§å­—èŠ‚ç æ ‡å‡†`ã€‚ è¿™æ„å‘³ç€ä»»ä½•è¯­è¨€éƒ½èƒ½å®ç°å®ƒã€‚ æ¯”å¦‚ golang  å’Œ rust å°±æä¾›äº†æŠŠä»£ç ç¼–è¯‘æˆ `WebAssembly` å­—èŠ‚ç çš„å®ç°ã€‚


![1.jpg](./img/2.jpg)

**è¿™é‡Œéœ€è¦å€¼å¾—æ³¨æ„æ˜¯çš„ï¼Œä¸åŒè¯­è¨€ç¼–è¯‘ç”Ÿæˆçš„ WebAssembly æ–‡ä»¶çš„è¿è¡Œæ€§èƒ½å¹¶ä¸å®Œå…¨ä¸€æ ·ã€‚**

WebAssembly åªæ˜¯ä¸€ç§æ ‡å‡†ï¼Œå…·ä½“çš„æ€§èƒ½å–å†³äºå®ç°å®ƒçš„æ–¹å¼ï¼Œå°±åƒä¸åŒæ°´å¹³çš„ç¨‹åºå‘˜ä½¿ç”¨åŒä¸€ç§è¯­è¨€å†™å‡ºæ¥çš„ä»£ç æ€§èƒ½ä¹Ÿä¼šæœ‰å·®å¼‚ä¸€æ ·ï¼Œå„ä¸ªè¯­è¨€ç¼–è¯‘æˆ WebAssembly çš„æ—¶å€™ä¹Ÿä¼šæŠŠè¯¥è¯­è¨€çš„ç‰¹æ€§ç»™ç¼–è¯‘è¿›å»ï¼Œä¾‹å¦‚åƒåœ¾å›æ”¶ï¼Œ å¹¶å‘æ¨¡å‹ç­‰ç­‰ã€‚ å†å åŠ ä¸åŒè¯­è¨€æä¾›çš„ wasm ç¼–è¯‘å™¨æœ‰å¥½æœ‰åï¼Œå› æ­¤æ€§èƒ½ä¸Šä¹Ÿä¼šæœ‰å·®å¼‚ï¼Œè¿™ä¸€ç‚¹å¾ˆå°‘åšå®¢æåŠã€‚

çœå»äº†  `Parser` å’Œ  `Ignition`  è¿™ä¸¤ä¸ªæ­¥éª¤ï¼Œä½¿å¾— `WebAssembly` å¦‚é™æ€è¯­è¨€ä¸€èˆ¬åœ¨æµè§ˆå™¨æ‰§è¡Œï¼Œæ€§èƒ½å¸¦æ¥äº†éå¸¸å¯è§‚çš„æå‡ï¼Œ

![1.jpg](./img/3.jpg)

å…³äºæ€§èƒ½çš„éƒ¨åˆ†ï¼Œæˆ‘æ›´å¤šçš„ä¹Ÿæ˜¯å‚è€ƒç½‘ä¸Šçš„ç›¸å…³èµ„æ–™, å¤§å®¶æ„Ÿå…´è¶£çš„è¯å¯ä»¥çœ‹ä¸€ä¸‹

*   [WASM isn't necessarily faster than JS](https://www.reddit.com/r/webdev/comments/uj8ivc/wasm_isnt_necessarily_faster_than_js/)
*   [WebAssembly vs Javascript](https://ianjk.com/webassembly-vs-javascript/?ck_subscriber_id=1715213923)

æ³¨æ„ï¼š WebAssembly ä¸æ˜¯ä¸‡èƒ½è§£è¯ï¼Œ å¹¶ä¸ä¸€å®šèƒ½ç»™ä½ å¸¦æ¥ç™¾åˆ†ä¹‹ç™¾çš„æ€§èƒ½æå‡ï¼Œ ä½¿ç”¨ `js -> WebAssembly `æ—¶ä¼šé¢å¤–å¤šåºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„å¼€é”€ï¼Œ å› æ­¤æ¯”å¦‚ä½ ç”¨ wasm ç¨‹åºä»…ä»…è¯»å–ä¸€ä¸ªè¶…å¤§åˆ—è¡¨çš„é•¿åº¦ï¼Œ å¯èƒ½èŠ±åœ¨åºåˆ—åŒ–ä¸Šçš„æ—¶é—´+è¿è¡Œçš„æ—¶é—´æ¯”ä½ ç›´æ¥ç”¨ js è¿˜æ…¢å¾ˆå¤šã€‚

## ç°åœ¨ç»ˆäºå¯ä»¥å¼€å§‹è¯´ä¼˜ç¼ºç‚¹äº†

### ä¼˜ç‚¹

1.  æ€§èƒ½ï¼šWasm ä»£ç åœ¨ Web æµè§ˆå™¨ä¸Šè¿è¡Œé€Ÿåº¦æ¯” JavaScript å¿«å¾—å¤šï¼Œè¿™ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿåœ¨ Web æµè§ˆå™¨ä¸Šå®ç°æ›´å¤æ‚ã€æ›´å¤šåŠŸèƒ½çš„åº”ç”¨ã€‚
2.  å®‰å…¨ï¼šWasm ä»£ç è¿è¡Œåœ¨æ²™ç®±ç¯å¢ƒä¸­ï¼Œä»è€Œä¿è¯äº†åº”ç”¨çš„å®‰å…¨æ€§ã€‚
3.  å¯ç§»æ¤æ€§ï¼šWasm ä»£ç æ˜¯äºŒè¿›åˆ¶çš„ï¼Œå¯ä»¥åœ¨ä»»ä½•æ”¯æŒ Wasm çš„å¹³å°ä¸Šè¿è¡Œï¼Œä»è€Œå®ç°ä»£ç çš„å¯ç§»æ¤æ€§ã€‚
4.  çµæ´»æ€§ï¼šWasm æ”¯æŒå¤šç§è¯­è¨€çš„ç¼–å†™ï¼ŒåŒ…æ‹¬ C/C++ã€Rustã€Go ç­‰ï¼Œè¿™ä½¿å¾—å¼€å‘è€…èƒ½å¤Ÿä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€ç¼–å†™ Web åº”ç”¨ã€‚

### ç¼ºç‚¹:

1.  é€‚ç”¨åœºæ™¯è¾ƒå°‘ï¼Œé€‚åˆ CPU å¯†é›†å‹çš„åœºæ™¯ï¼ˆæ¯”å¦‚ 3D æ¸²æŸ“ï¼Œ å›¾åƒè§†é¢‘å¤„ç†ï¼Œåœ¨çº¿æ¸¸æˆï¼‰, ç›®å‰ `Photoshop`ï¼Œ `Figma`, `AutoCAD` è¿˜æœ‰ `è°·æ­Œåœ°çƒ` å‡ä½¿ç”¨äº† WebAssembly æŠ€æœ¯ã€‚
2.  å’Œ JS æœ‰é€šä¿¡çš„æˆæœ¬ï¼Œé€šä¿¡é¢‘ç¹æˆ–æ•°æ®é‡å¤§ä¼šé™ä½æ€§èƒ½ã€‚js äº wasm é€šä¿¡ä¼šå¸¦æ¥æ¯”è¾ƒå¤§çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æˆæœ¬ã€‚
3.  å¯¹å‰ç«¯ä¸å‹å¥½ï¼Œè®©å‰ç«¯å­¦ rust å†™ wasm . å‰ç«¯ä¸ºå•¥ä¸ç”¨ rust å†™æ›´ç‰› x çš„è½¯ä»¶æ¶¨è–ªå‘¢ï¼Ÿ
4.  è°ƒè¯•èµ·æ¥æ¯”è¾ƒéº»çƒ¦ï¼Œä½ çš„ä»£ç ç»è¿‡ wasm ç¼–è¯‘ä¹‹åå‡ ä¹å·²ç»æˆäº†å¦å¤–ä¸€å‰¯æ ·å­ã€‚

## â˜„ï¸ æ¥ä¸€åœºé…£ç•…æ·‹æ¼“çš„å®æˆ˜å§ ï¼

å†™äº†è¿™ä¹ˆå¤šï¼Œç»ˆäºæŠŠèƒŒæ™¯çŸ¥è¯†å†™å®Œäº†ï¼Œæ¥ä¸‹æ¥å‘¢ï¼Œæˆ‘ä»¬å°†ä¼šä½¿ç”¨ golang ç¼–å†™ä¸€ä¸ªå¯ä»¥åŠ¨æ€ç»™å›¾ç‰‡åŠ æ°´å°çš„ï¼Œ ç”±äºgolangçš„é‚£ä¸ªåº“åªæä¾›äº†å¯¹ jpg çš„æ”¯æŒï¼Œ å› æ­¤åªæ”¯æŒç»™ jpg æ–‡ä»¶åŠ æ°´å°ã€‚ é¢„æœŸå®ç°çš„æ•ˆæœæ˜¯è¿™æ ·çš„:

![1.jpg](./img/4.jpg)

æ¥ä¸‹æ¥çš„ç¤ºä¾‹ä¸­ï¼Œ ä¸ºäº†ä¿è¯é˜…è¯»ä½“éªŒï¼Œ æœ¬æ–‡åªä¼šå±•ç¤ºéƒ¨åˆ†æ ¸å¿ƒä»£ç ï¼Œ è¯¦ç»†çš„ç¤ºä¾‹ä»£ç å·²ç»å¼€æºåˆ° github ä»£ç è¯¥ç¬”è®°å¯¹åº”çš„ç›®å½•ä¸‹ï¼Œéœ€è¦çš„åŒå­¦å¯ä»¥è‡ªè¡Œè·å–ã€‚

## è®¾ç½® IDE

å¦‚æœä½ æ˜¯ Glang åº”ç”¨ï¼Œ é‚£ä¹ˆä½ éœ€è¦ æå‰è®¾ç½®ä¸€ä¸‹ä½ çš„ Goland  IDEï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

![1.jpg](./img/5.jpg)


### æ–°å»ºä¸€ä¸ª main.go, ç¼–å†™æˆ‘ä»¬çš„ä»£ç 

```go
package main

import (
    "bytes"
    _ "embed"
    "fmt"
    "golang.org/x/image/font"
    "golang.org/x/image/font/basicfont"
    "golang.org/x/image/math/fixed"
    "image"
    "image/color"
    "image/draw"
    "image/jpeg"
    "syscall/js"
)

// çœç•¥ä¸€éƒ¨åˆ†ä»£ç 

func processImage(this js.Value, p []js.Value) interface{} {
    if len(p) < 2 {
       js.Global().Get("console").Call("log", "Error: Insufficient arguments")
       return nil
    }

    imgData := p[0] // è¿™é‡Œèƒ½è¯»å– js ä¼ è¿‡æ¥çš„å‚æ•°
    watermarkText := p[1].String() // è¿™é‡Œèƒ½è¯»å– js ä¼ è¿‡æ¥çš„å‚æ•°
    
    // çœç•¥ä¸€éƒ¨åˆ†ä»£ç 
}

func main() {
    ch := make(chan struct{}, 0)
    // è¾“å‡ºå°†æ‰“å°åœ¨ console log ä¸­
    fmt.Println("Hello Web Assembly from Go!")
    var a []string
    a = append(a, "1")
    // å°†å‡½æ•°å¯¼å‡ºåˆ°å…¨å±€JavaScriptç¯å¢ƒï¼Œä»¥ä¾¿åœ¨JavaScriptä¸­è°ƒç”¨
    js.Global().Set("processImage", js.FuncOf(processImage))
    // ä»é€šé“ ch ä¸­æ¥æ”¶æ•°æ®ã€‚è¯¥æ“ä½œä¼šé˜»å¡ï¼Œé˜²æ­¢ä¸»ç¨‹åºé€€å‡ºï¼Œç›´åˆ°ä»é€šé“ä¸­æ¥æ”¶åˆ°æ•°æ®
    <-ch
}

```

### ç¼–è¯‘æˆ‘ä»¬çš„ main.go to wasm

æ³¨æ„ï¼Œå½“ golang çš„ä»£ç è¢«ç¼–è¯‘æˆ wasm ä¹‹åï¼Œè·Ÿ golang å°±ä¸å­˜åœ¨è¿è¡Œæ—¶çš„å…³ç³»äº†ï¼Œä¹Ÿå°±æ˜¯ main.wasm å’Œ golang ç¼–è¯‘æˆçš„äºŒè¿›åˆ¶ä¸€æ ·ï¼Œä¸éœ€è¦ golang æä¾›è¿è¡Œæ—¶ã€‚

```bash
GOOS=js GOARCH=wasm go build -o main.wasm 
```

è™½ç„¶ main.wasm æ˜¯ä¸ªäºŒè¿›åˆ¶ï¼Œä½†æ˜¯æ˜¯å¯ä»¥è¢«è½¬æ¢æˆ Wasm çš„æ–‡æœ¬æ–‡ä»¶çš„ï¼Œ`å¥½å¤„æ˜¯ï¼Œå¾ˆå¥½è½¬ï¼Œåå¤„æ˜¯ï¼Œå‡ ä¹ä¸å¯è¯»`ã€‚æ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥æŠŠ main.wasm æ–‡ä»¶æ‹–æ‹½åˆ°è¿™ä¸ªç½‘ç«™çœ‹çœ‹: [ä¼ é€é—¨](https://wasmdev.cn/wabt-online/wasm2wat/index.html)

### ç¼–å†™æˆ‘ä»¬çš„ index.html

æ–°å»ºä¸€ä¸ª assets æ–‡ä»¶, å°†ä¸Šä¸€æ­¥ç¼–è¯‘å¥½çš„ `main.wasm` æ”¾å…¥ `assets` ä¸‹ã€‚æ‰§è¡Œä»¥ä¸‹å‘½ä»¤
å°† `wasm_exec.js` æ–‡ä»¶æ‹·è´è‡³  `assets` ç›®å½•ä¸‹ã€‚

```bash

cp "$(go env GOROOT)/misc/wasm/wasm_exec.js" ./assets
```

åœ¨ assets æ–°å¢ `index.html` æ–‡ä»¶ï¼Œç¢äºæœ¬æ–‡ç¯‡å¹…ï¼Œçœç•¥äº†éƒ¨åˆ†ä»£ç ã€‚

```html
<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <title>Image Watermark with WASM</title>
    <style>
        // css çœç•¥æ‰äº†
    </style>
    <script src="wasm_exec.js" type="text/javascript"></script>
</head>
<body>
<div class="container">
    <h1>Image Watermark with WASM</h1>
    <p class="instructions">è¯·é€‰æ‹©ä¸€å¼ å›¾ç‰‡ï¼Œç„¶åè¾“å…¥æ°´å°æ–‡å­—ï¼Œæœ€åç‚¹å‡»â€œæ·»åŠ æ°´å°â€æŒ‰é’®ã€‚</p>
    <div class="input-group">
        <label for="imageInput">é€‰æ‹©å›¾ç‰‡ï¼š</label>
        <input type="file" id="imageInput" accept="image/*">
    </div>
    <div class="input-group">
        <label for="watermarkText">æ°´å°æ–‡å­—ï¼š</label>
        <input type="text" id="watermarkText" placeholder="è¯·è¾“å…¥æ°´å°æ–‡å­—">
    </div>
    <button onclick="addWatermark()">æ·»åŠ æ°´å°</button>
    <button onclick="reset()">é‡ç½®</button>
</div>
<div class="result-container">
    <img id="resultImg" alt="ç»“æœå›¾ç‰‡å°†æ˜¾ç¤ºåœ¨æ­¤å¤„">
</div>
<script>
    const go = new Go();
    WebAssembly.instantiateStreaming(fetch("main.wasm"), go.importObject).then((result) => {
        go.run(result.instance);
    });

    function addWatermark() {
        const imgInput = document.getElementById('imageInput').files[0];
        const watermarkText = document.getElementById('watermarkText').value;

        if (!imgInput || !watermarkText) {
            alert("è¯·é€‰æ‹©å›¾ç‰‡å¹¶è¾“å…¥æ°´å°æ–‡å­—ã€‚");
            return;
        }

        const imgReader = new FileReader();

        imgReader.onload = function (e) {
            const imgArray = new Uint8Array(e.target.result);
            // åœ¨è¿™é‡Œæˆ‘ä»¬æŠŠå‚æ•°é€šè¿‡ js ä¼ é€’ç»™äº† wasmï¼Œå¹¶è·å–åˆ°äº† processImage å¤„ç†ä¹‹åçš„ç»“æœ
            const result = processImage(imgArray, watermarkText);
            if (result) {
                const blob = new Blob([result], { type: "image/jpeg" });
                document.getElementById('resultImg').src = URL.createObjectURL(blob);
            } else {
                alert("å¤„ç†å›¾ç‰‡æ—¶å‡ºé”™");
            }
        };
        imgReader.readAsArrayBuffer(imgInput);
    }

    function reset() {
        document.getElementById('imageInput').value = "";
        document.getElementById('watermarkText').value = "";
        document.getElementById('resultImg').src = "";
    }
</script>
</body>
</html>

```

ç›´æ¥æµè§ˆå™¨æ‰“å¼€ index.html å³å¯, ä¸å‡ºæ„å¤–çš„è¯åº”è¯¥å¯ä»¥çœ‹åˆ°æœ€ç»ˆçš„æ•ˆæœäº†ã€‚

## ğŸ€„ï¸ æ€»ç»“

è™½ç„¶ WebAssembly çœ‹èµ·æ¥å¾ˆå¥½ï¼Œä½†æ˜¯é€‚ç”¨çš„åœºæ™¯ä¹Ÿæ˜¯éå¸¸æœ‰é™çš„, WebAssembly å¹¶ä¸æ˜¯ä¸ºäº†æ›¿ä»£ js, æ¯•ç«Ÿåœ¨ 90% çš„åœºæ™¯ä¸‹ï¼Œjs çš„æ€§èƒ½æ˜¯å®Œå…¨å¤Ÿç”¨çš„ï¼Œå¤§å¤šæ•°æƒ…å†µä¸‹é‡åˆ°çš„æ€§èƒ½é—®é¢˜å¾€å¾€æ˜¯å¼€å‘è€…ä½¿ç”¨äº†é”™è¯¯çš„æ–¹å¼å¯¼è‡´çš„(å†™äº†å¤§é‡çš„é€’å½’å’Œä½æ•ˆç‡çš„ä»£ç )ã€‚WebAssembly æ›´é€‚åˆå’Œ js ç»„åˆä½¿ç”¨ï¼Œä½œä¸º js åœ¨æ€§èƒ½è¿™ä¸€å—çŸ­æ¿çš„è¡¥å……ï¼Œå¯¹äº js è€Œè¨€ï¼ŒWebAssembly æ›´åƒæ˜¯æ”¾åœ¨åŒ»é™¢é‡Œé¢çš„é‚£äº›é«˜æ˜‚çš„è¿›å£è¯ï¼Œè™½ç„¶å¤§å¤šæ•°æ—¶å€™éƒ½ç”¨ä¸ä¸Šï¼Œä½†æ˜¯ç”¨åˆ°çš„æ—¶å€™å¾€å¾€èƒ½èµ·åˆ°éå¸¸å…³é”®çš„ä½œç”¨ã€‚

æœ¬æ–‡é™„å¸¦çš„ä»£ç åœ°å€ï¼š

https://github.com/hanshuaikang/HanShu-Note-Sisyphus/tree/main/%E5%85%B6%E4%BB%96/Go%20Web%20Assembly/code/wasm
